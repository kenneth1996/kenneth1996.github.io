<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">

    

    

    <title>云原生(二)Helm-kubernetes包管理工具 | SRE</title>
    <meta name="author" content="John Doe">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="一、Helm是什么？1、简介Helm 是一个用于 Kubernetes 应用的包管理工具，主要用来管理 Charts。有点类似于 Ubuntu 中的 APT 或 CentOS 中的YUM。Helm Chart 是用来封装 Kubernetes 原生应用程序的一系列 YAML 文件。可以在你部署应用的时候自定义应用程序的一些 Metadata，以便于应用程序的分发。对于应用发布者而言，可以通过 Helm 打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。对于使用者而言，使...">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="SRE" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">SRE</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories/front-end">
                <span class="nav-text">Linux</span>
            </a>
        
            <a class="nav-item" href="/categories/back-end">
                <span class="nav-text">Python</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://kenneth96.coding.me"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、Helm是什么？"><span class="toc-number">1.</span> <span class="toc-text">一、Helm是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、简介"><span class="toc-number">1.1.</span> <span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、三大概念"><span class="toc-number">1.2.</span> <span class="toc-text">2、三大概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、特点"><span class="toc-number">1.3.</span> <span class="toc-text">3、特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、组件"><span class="toc-number">1.4.</span> <span class="toc-text">4、组件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、Helm入门"><span class="toc-number">2.</span> <span class="toc-text">二、Helm入门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、基础环境"><span class="toc-number">2.1.</span> <span class="toc-text">1、基础环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、安全部署"><span class="toc-number">2.2.</span> <span class="toc-text">2、安全部署</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#①Helm客户端安装"><span class="toc-number">2.2.1.</span> <span class="toc-text">①Helm客户端安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#②Helm服务端安装"><span class="toc-number">2.2.2.</span> <span class="toc-text">②Helm服务端安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#③认证授权"><span class="toc-number">2.2.3.</span> <span class="toc-text">③认证授权</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#④验证是否安装成功"><span class="toc-number">2.2.4.</span> <span class="toc-text">④验证是否安装成功</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、基础配置"><span class="toc-number">2.3.</span> <span class="toc-text">3、基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#①更换仓库"><span class="toc-number">2.3.1.</span> <span class="toc-text">①更换仓库</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#②查看在存储库中可用的所有-Helm-charts"><span class="toc-number">2.3.2.</span> <span class="toc-text">②查看在存储库中可用的所有 Helm charts</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#③更新charts列表"><span class="toc-number">2.3.3.</span> <span class="toc-text">③更新charts列表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、构建一个Helm-chart"><span class="toc-number">3.</span> <span class="toc-text">三、构建一个Helm chart</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、创建第一个Chart"><span class="toc-number">3.1.</span> <span class="toc-text">1、创建第一个Chart</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、编写应用介绍信息"><span class="toc-number">3.2.</span> <span class="toc-text">2、编写应用介绍信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、编写应用部署信息"><span class="toc-number">3.3.</span> <span class="toc-text">3、编写应用部署信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、检测配置是否正确"><span class="toc-number">3.4.</span> <span class="toc-text">4、检测配置是否正确</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5、应用打包"><span class="toc-number">3.5.</span> <span class="toc-text">5、应用打包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6、发布到本地仓库"><span class="toc-number">3.6.</span> <span class="toc-text">6、发布到本地仓库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四、在-Kubernetes-中构建"><span class="toc-number">4.</span> <span class="toc-text">四、在 Kubernetes 中构建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、部署"><span class="toc-number">4.1.</span> <span class="toc-text">1、部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、升级"><span class="toc-number">4.2.</span> <span class="toc-text">2、升级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、回退"><span class="toc-number">4.3.</span> <span class="toc-text">3、回退</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、删除"><span class="toc-number">4.4.</span> <span class="toc-text">4、删除</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            云原生(二)Helm-kubernetes包管理工具
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://kenneth96.coding.me/2019/05/09/云原生-二-Helm-kubernetes包管理工具/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-05-09T03:06:25.000Z" itemprop="datePublished">2019-05-09</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/k8s/">k8s</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="一、Helm是什么？"><a href="#一、Helm是什么？" class="headerlink" title="一、Helm是什么？"></a>一、Helm是什么？</h4><p><img src="https://k-linux.oss-cn-beijing.aliyuncs.com/images/1556092664%281%29.png" alt=""></p>
<h5 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h5><p>Helm 是一个用于 Kubernetes 应用的包管理工具，主要用来管理 Charts。有点类似于 Ubuntu 中的 APT 或 CentOS 中的YUM。</p>
<p>Helm Chart 是用来封装 Kubernetes 原生应用程序的一系列 YAML 文件。可以在你部署应用的时候自定义应用程序的一些 Metadata，以便于应用程序的分发。</p>
<p>对于应用发布者而言，可以通过 Helm 打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。</p>
<p>对于使用者而言，使用 Helm 后不用需要编写复杂的应用部署文件，可以以简单的方式在 Kubernetes 上查找、安装、升级、回滚、卸载应用程序。</p>
<h5 id="2、三大概念"><a href="#2、三大概念" class="headerlink" title="2、三大概念"></a>2、三大概念</h5><p>一个 Chart 是一个 Helm 包。它包含在 Kubernetes 集群内部运行应用程序，工具或服务所需的所有资源定义。把<br>它想像为一个自制软件，一个 Apt dpkg 或一个 Yum RPM 文件的 Kubernetes 环境里面的等价物。<br>一个 Repository 是 Charts 收集和共享的地方。它就像 Perl 的 CPAN archive 或 Fedora 软件包 repoFedora<br>Package Database。<br>一个 Release 是处于 Kubernetes 集群中运行的 Chart 的一个实例。一个 chart 通常可以多次安装到同一个群集<br>中。每次安装时，都会创建一个新 release 。比如像一个 MySQL chart。如果希望在群集中运行两个数据库，则可以安装该 chart 两次。每个都有自己的 release，每个 release 都有自己的 release name。<br>有了这些概念，我们现在可以这样解释 Helm：<br>Helm 将 charts 安装到 Kubernetes 中，每个安装创建一个新 release 。要找到新的 chart，可以搜索 Helm charts存储库 repositories。</p>
<h5 id="3、特点"><a href="#3、特点" class="headerlink" title="3、特点"></a>3、特点</h5><p>Helm 是管理称为 chart 的 Kubernetes 包的工具。Helm 可以做到以下几点：</p>
<ul>
<li>从头开始创建新 chart</li>
<li>将 chart 打包成 chart 归档（tgz）文件</li>
<li>与存储 chart 的 chart 存储库交互</li>
<li>安装或卸载 chart 到现有的 Kubernetes 集群中</li>
<li>管理用 Helm 安装的 chart 的 release 周期</li>
</ul>
<p>对于 Helm，有三个重要的概念：</p>
<ul>
<li>chart 是创建 Kubernetes 应用程序实例所需的一系列信息。</li>
<li>配置包含可以合并到打包 chart 以创建可发布对象的配置信息。</li>
<li>Release 是一个的运行实例的 chart，具有特定的组合配置。</li>
</ul>
<h5 id="4、组件"><a href="#4、组件" class="headerlink" title="4、组件"></a>4、组件</h5><p>Helm 有两个主要部分：</p>
<p><strong>Helm Client</strong> 是最终用户的命令行客户端。客户端负责以下部分：</p>
<ul>
<li>本地 chart 开发</li>
<li>管理存储库</li>
<li>与 Tiller 服务交互</li>
<li>发送要安装的 chart</li>
<li>查询有关发布的信息</li>
<li>请求升级或卸载现有 release</li>
</ul>
<p><strong>Tiller Server</strong> 是一个集群内服务，与 Helm 客户端进行交互，并与 Kubernetes API 服务进行交互。服务负责以下内容：</p>
<ul>
<li>监听来自 Helm 客户端的传入请求</li>
<li>结合 chart 和配置来构建发布</li>
<li>将 chart 安装到 Kubernetes 中，然后跟踪后续 release</li>
<li>通过与 Kubernetes 交互来升级和卸载 chart</li>
</ul>
<p>简而言之，客户端负责管理 chart，而服务端负责管理 release。</p>
<h4 id="二、Helm入门"><a href="#二、Helm入门" class="headerlink" title="二、Helm入门"></a>二、Helm入门</h4><p>Helm 客户端使用 Go 编程语言编写，并使用 gRPC 协议套件与 Tiller 服务进行交互。</p>
<p>Tiller 服务也用 Go 编写。它提供了一个与客户端连接的 gRPC 服务，它使用 Kubernetes 客户端库与 Kubernetes 进行通信。目前，该库使用 REST + JSON。</p>
<p>Tiller 服务将信息存储在位于 Kubernetes 内的 ConfigMaps 中。它不需要自己的数据库。</p>
<p>如有可能，配置文件用YAML编写。</p>
<h5 id="1、基础环境"><a href="#1、基础环境" class="headerlink" title="1、基础环境"></a>1、基础环境</h5><table>
<thead>
<tr>
<th style="text-align:center">操作系统</th>
<th style="text-align:center">CentOS Linux release 7.6.1810</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Kubernetes</td>
<td style="text-align:center">1.14.0</td>
</tr>
<tr>
<td style="text-align:center">Helm</td>
<td style="text-align:center">2.13.1</td>
</tr>
<tr>
<td style="text-align:center">Tiller</td>
<td style="text-align:center">2.13.1</td>
</tr>
</tbody>
</table>
<h5 id="2、安全部署"><a href="#2、安全部署" class="headerlink" title="2、安全部署"></a>2、安全部署</h5><p><strong>注意！客户端跟服务端版本一定要一致</strong></p>
<h6 id="①Helm客户端安装"><a href="#①Helm客户端安装" class="headerlink" title="①Helm客户端安装"></a>①Helm客户端安装</h6><blockquote>
<p>方式一：使用官方提供的脚本一键安装</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; get_helm.sh</span><br><span class="line">$ chmod <span class="number">700</span> get_helm.sh</span><br><span class="line">$ ./get_helm.sh</span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式二：手动下载安装</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.<span class="number">13.1</span>-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 把 helm 指令放到bin目录下</span></span><br><span class="line">$ mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">$ helm version</span><br></pre></td></tr></table></figure>
<h6 id="②Helm服务端安装"><a href="#②Helm服务端安装" class="headerlink" title="②Helm服务端安装"></a>②Helm服务端安装</h6><p>先在 K8S 集群上每个节点安装 socat 软件(yum install -y socat )，不然会报如下错误：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E0522 <span class="number">22</span>:<span class="number">22</span>:<span class="number">15.492436</span>   <span class="number">24409</span> portforward.go:<span class="number">331</span>] an error occurred forwarding <span class="number">38398</span> -&gt; <span class="number">44134</span>: error forwarding port <span class="number">44134</span> to pod dc6da4ab99ad9c497c0cef1776b9dd18e0a612d507e2746ed63d36ef40f30174, uid : unable to <span class="keyword">do</span> port forwarding: socat not found.</span><br><span class="line">Error: cannot connect to Tiller</span><br></pre></td></tr></table></figure>
<p>Tiller 是以 Deployment 方式部署在 Kubernetes 集群中的，只需使用以下指令便可简单的完成安装。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init</span><br></pre></td></tr></table></figure>
<p>由于 Helm 默认会去 storage.googleapis.com 拉取镜像，如果你当前执行的机器不能访问该域名的话可以使用以下命令来安装： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm init --client-only --stable-repo-url https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts/</span><br><span class="line">helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br><span class="line">helm repo update</span><br><span class="line"><span class="comment"># 创建服务端</span></span><br><span class="line">helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.<span class="number">13.1</span>  --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="comment"># 创建TLS认证服务端，参考地址：https://github.com/gjmzj/kubeasz/blob/master/docs/guide/helm.md</span></span><br><span class="line">helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.<span class="number">13.1</span> --tiller-tls-cert /etc/kubernetes/ssl/tiller001.pem --tiller-tls-key /etc/kubernetes/ssl/tiller001-key.pem --tls-ca-cert /etc/kubernetes/ssl/ca.pem --tiller-namespace kube-system --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<p>在 Kubernetes 中安装 Tiller 服务，因为官方的镜像因为某些原因无法拉取，使用-i指定自己的镜像，可选镜像：registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1（阿里云），该镜像的版本与helm客户端的版本相同，使用helm version可查看helm客户端版本。如果在用helm init安装tiller server时一直部署不成功,检查deployment，根据描述解决问题。</p>
<h6 id="③认证授权"><a href="#③认证授权" class="headerlink" title="③认证授权"></a>③认证授权</h6><p>因为 Helm 的服务端 Tiller 是一个部署在 Kubernetes 中 Kube-System Namespace 下 的 Deployment，它会去连接 Kube-Api 在 Kubernetes 里创建和删除应用。</p>
<p>而从 Kubernetes 1.6 版本开始，API Server 启用了 RBAC 授权。目前的 Tiller 部署时默认没有定义授权的 ServiceAccount，这会导致访问 API Server 时被拒绝。所以我们需要明确为 Tiller 部署添加授权。</p>
<blockquote>
<p>创建 Kubernetes 的服务帐号和绑定角色</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># kubectl create serviceaccount --namespace kube-system tiller</span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>为 Tiller 设置帐号 </p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 kubectl patch 更新 API 对象</span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># kubectl patch deploy --namespace kube-system tiller-deploy -p '&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></span><br><span class="line">deployment.extensions <span class="string">"tiller-deploy"</span> patched</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查看是否授权成功 </p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># kubectl get deploy --namespace kube-system   tiller-deploy  --output yaml|grep  serviceAccount</span></span><br><span class="line">serviceAccount: tiller</span><br><span class="line">serviceAccountName: tiller</span><br></pre></td></tr></table></figure>
<h6 id="④验证是否安装成功"><a href="#④验证是否安装成功" class="headerlink" title="④验证是否安装成功"></a>④验证是否安装成功</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># kubectl -n kube-system get pods|grep tiller</span></span><br><span class="line">tiller-deploy-<span class="number">7</span>cb87ddf7d-<span class="number">9</span>kkjt   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">20</span>d</span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.13.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.13.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>如果你需要在 Kubernetes 中卸载已部署的 Tiller，可使用以下命令完成卸载。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm reset 或</span><br><span class="line">$ helm reset --force</span><br></pre></td></tr></table></figure>
<h5 id="3、基础配置"><a href="#3、基础配置" class="headerlink" title="3、基础配置"></a>3、基础配置</h5><h6 id="①更换仓库"><a href="#①更换仓库" class="headerlink" title="①更换仓库"></a>①更换仓库</h6><p>若遇到Unable to get an update from the “stable” chart repository (<a href="https://kubernetes-charts.storage.googleapis.com/" target="_blank" rel="noopener">https://kubernetes-charts.storage.googleapis.com</a>) 错误 手动更换stable 存储库为阿里云的存储库 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先移除原先的仓库</span></span><br><span class="line">helm repo remove stable</span><br><span class="line"><span class="comment"># 添加新的仓库地址</span></span><br><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="comment"># 更新仓库</span></span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<h6 id="②查看在存储库中可用的所有-Helm-charts"><a href="#②查看在存储库中可用的所有-Helm-charts" class="headerlink" title="②查看在存储库中可用的所有 Helm charts"></a>②查看在存储库中可用的所有 Helm charts</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">helm search</span><br><span class="line"> </span><br><span class="line">NAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       </span><br><span class="line">stable/acs-engine-autoscaler    <span class="number">2.1</span>.<span class="number">3</span>           <span class="number">2.1</span>.<span class="number">1</span>           Scales worker nodes within agent pools            </span><br><span class="line">stable/aerospike                <span class="number">0.1</span>.<span class="number">7</span>           v3.<span class="number">14.1</span>.<span class="number">2</span>       A Helm chart <span class="keyword">for</span> Aerospike <span class="keyword">in</span> Kubernetes          </span><br><span class="line">stable/anchore-engine           <span class="number">0.1</span>.<span class="number">3</span>           <span class="number">0.1</span>.<span class="number">6</span>           Anchore container analysis and policy evaluatio...</span><br><span class="line">stable/artifactory              <span class="number">7.0</span>.<span class="number">3</span>           <span class="number">5.8</span>.<span class="number">4</span>           Universal Repository Manager supporting all maj...</span><br><span class="line">stable/artifactory-ha           <span class="number">0.1</span>.<span class="number">0</span>           <span class="number">5.8</span>.<span class="number">4</span>           Universal Repository Manager supporting all maj...</span><br><span class="line">stable/aws-cluster-autoscaler   <span class="number">0.3</span>.<span class="number">2</span>                           Scales worker nodes within autoscaling groups.</span><br><span class="line">... ...</span><br></pre></td></tr></table></figure>
<h6 id="③更新charts列表"><a href="#③更新charts列表" class="headerlink" title="③更新charts列表"></a>③更新charts列表</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<h4 id="三、构建一个Helm-chart"><a href="#三、构建一个Helm-chart" class="headerlink" title="三、构建一个Helm chart"></a>三、构建一个Helm chart</h4><p>下面我们通过一个完整的示例来学习如何使用 Helm 创建、打包、分发、安装、升级及回退Kubernetes应用。 </p>
<h5 id="1、创建第一个Chart"><a href="#1、创建第一个Chart" class="headerlink" title="1、创建第一个Chart"></a>1、创建第一个Chart</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm create mychart</span></span><br><span class="line">Creating mychart</span><br></pre></td></tr></table></figure>
<p>该命令创建了一个 mychart 目录，该目录结构如下所示。这里我们主要关注目录中的 <code>Chart.yaml</code>、<code>values.yaml</code>、<code>NOTES.txt</code> 和 <code>Templates</code> 目录。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># tree mychart/</span></span><br><span class="line">mychart/</span><br><span class="line">├── charts <span class="comment">#依赖的chart</span></span><br><span class="line">├── Chart.yaml <span class="comment">#Chart本身的版本和配置信息</span></span><br><span class="line">├── templates <span class="comment">#目录用于放置模板文件</span></span><br><span class="line">│   ├── deployment.yaml <span class="comment">#kubernetes Deployment object</span></span><br><span class="line">│   ├── _helpers.tpl <span class="comment">#用于修改kubernetes objcet配置的模板</span></span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt <span class="comment">#helm提示信息</span></span><br><span class="line">│   ├── service.yaml <span class="comment">#kubernetes Serivce</span></span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml <span class="comment">#kubernetes object configuration</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Chart.yaml：用于描述这个 Chart的相关信息，包括名字、描述信息以及版本等。</li>
<li>Templates：目录下是 YAML 文件的模板，该模板文件遵循 Go template 语法。</li>
<li>deployment.yaml：创建 Kubernetes deployment 的基本 manifest</li>
<li>_helpers.tpl ：放置模板助手的地方，可以在整个 chart 中重复使用</li>
<li>NOTES.txt：chart 的 “帮助文本”。这会在用户运行 helm install 时显示给用户。</li>
<li>service.yaml：为 deployment 创建 service 端点 service endpoint 的基本 manifes</li>
<li>values.yaml：用于存储 templates 目录中模板文件中用到变量的值。</li>
</ul>
<p><code>Templates</code> 目录下 YAML 文件模板的值默认都是在<code>values.yaml</code>里定义的，比如在 <code>deployment.yaml</code> 中定义的容器镜像。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image: <span class="string">"&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;"</span></span><br></pre></td></tr></table></figure>
<p>其中的 <code>.Values.image.repository</code> 的值就是在 values.yaml 里定义的 nginx，<code>.Values.image.tag</code>的值就是 stable。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># cat mychart/values.yaml|grep repository</span></span><br><span class="line">  repository: nginx</span><br><span class="line">[root@k8s-m ~]<span class="comment"># cat mychart/values.yaml|grep tag</span></span><br><span class="line">  tag: stable</span><br></pre></td></tr></table></figure>
<p>以上两个变量值是在 <code>create chart</code> 的时候就自动生成的默认值，你可以根据实际情况进行修改。 </p>
<blockquote>
<p>如果你需要了解更多关于 Go 模板的相关信息，可以查看 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 的一个关于 <a href="https://gohugo.io/templates/go-templates/" target="_blank" rel="noopener">Go 模板</a> 的介绍。 </p>
</blockquote>
<h5 id="2、编写应用介绍信息"><a href="#2、编写应用介绍信息" class="headerlink" title="2、编写应用介绍信息"></a>2、编写应用介绍信息</h5><p>打开 Chart.yaml, 填写你部署的应用的详细信息，以 mychart 为例： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># cat mychart/Chart.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">appVersion: <span class="string">"1.0"</span></span><br><span class="line">description: A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">name: mychart</span><br><span class="line">version: <span class="number">0.1</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<h5 id="3、编写应用部署信息"><a href="#3、编写应用部署信息" class="headerlink" title="3、编写应用部署信息"></a>3、编写应用部署信息</h5><p>编辑 values.yaml，它默认会在 Kubernetes 部署一个 Nginx。下面是 mychart 应用的 values.yaml 文件的内容： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># cat mychart/values.yaml</span></span><br><span class="line"><span class="comment"># Default values for mychart.</span></span><br><span class="line"><span class="comment"># This is a YAML-formatted file.</span></span><br><span class="line"><span class="comment"># Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line">replicaCount: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  tag: stable</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">nameOverride: <span class="string">""</span></span><br><span class="line">fullnameOverride: <span class="string">""</span></span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: <span class="number">80</span></span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">    <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">    <span class="comment"># kubernetes.io/tls-acme: "true"</span></span><br><span class="line">  hosts:</span><br><span class="line">    - host: chart-example.local</span><br><span class="line">      paths: []</span><br><span class="line"></span><br><span class="line">  tls: []</span><br><span class="line">  <span class="comment">#  - secretName: chart-example-tls</span></span><br><span class="line">  <span class="comment">#    hosts:</span></span><br><span class="line">  <span class="comment">#      - chart-example.local</span></span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">  <span class="comment"># We usually recommend not to specify default resources and to leave this as a conscious</span></span><br><span class="line">  <span class="comment"># choice for the user. This also increases chances charts run on environments with little</span></span><br><span class="line">  <span class="comment"># resources, such as Minikube. If you do want to specify resources, uncomment the following</span></span><br><span class="line">  <span class="comment"># lines, adjust them as necessary, and remove the curly braces after 'resources:'.</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4、检测配置是否正确"><a href="#4、检测配置是否正确" class="headerlink" title="4、检测配置是否正确"></a>4、检测配置是否正确</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm lint mychart/</span></span><br><span class="line">==&gt; Linting mychart/</span><br><span class="line">[INFO] Chart.yaml: icon is recommended</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> chart(s) linted, no failures</span><br></pre></td></tr></table></figure>
<p>如果文件格式错误，可以根据提示进行修改。 </p>
<h5 id="5、应用打包"><a href="#5、应用打包" class="headerlink" title="5、应用打包"></a>5、应用打包</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm package mychart</span></span><br><span class="line">Successfully packaged chart and saved it to: /root/mychart-<span class="number">0.1</span>.<span class="number">0</span>.tgz</span><br></pre></td></tr></table></figure>
<p>mychart 目录会被打包为一个 mychart-0.1.0.tgz 格式的压缩包，该压缩包会被放到当前目录下，并同时被保存到了 Helm 的本地缺省仓库目录中。</p>
<p>如果你想看到更详细的输出，可以加上 <code>--debug</code> 参数来查看打包的输出，输出内容应该类似如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm package mychart --debug</span></span><br><span class="line">Successfully packaged chart and saved it to: /root/mychart-<span class="number">0.1</span>.<span class="number">0</span>.tgz</span><br><span class="line">[debug] Successfully saved /root/mychart-<span class="number">0.1</span>.<span class="number">0</span>.tgz to /root/.helm/repository/local</span><br></pre></td></tr></table></figure>
<h5 id="6、发布到本地仓库"><a href="#6、发布到本地仓库" class="headerlink" title="6、发布到本地仓库"></a>6、发布到本地仓库</h5><p>ceph-helm项目默认使用本地的Helm repo来存储charts。要启动本地Helm repo服务器，请运行： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># screen -S helm </span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm serve &amp;  </span></span><br><span class="line"><span class="comment">#Ctrl+A D 退出 </span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm repo add local http://localhost:8879/charts</span></span><br></pre></td></tr></table></figure>
<p>我们打包了Chart 的同时会自动发布到 Helm 的本地目录中，通过 <code>helm search</code> 命令查找，可以找到刚才生成的 mychart包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]# helm search mychart</span><br><span class="line">NAME            CHART VERSION   APP VERSION DESCRIPTION                </span><br><span class="line">local/mychart   0.1.0           1.0         A Helm chart for Kubernetes</span><br></pre></td></tr></table></figure>
<p>通过 <code>helm repo list</code> 命令可以看到目前 Helm 中已配置的 Repository 的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]# helm repo list</span><br><span class="line">NAME        URL                                                                      </span><br><span class="line">local       http://127.0.0.1:8879/charts                                             </span><br><span class="line">incubator   https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br><span class="line">stable      https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<p>如果你想使用指定目录来做为 Helm Repository 的存储目录，可以加上 <code>--repo-path</code> 参数： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># mkdir -p /data/helm/repository/</span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm serve --address 192.168.74.128:8879 --repo-path /data/helm/repository/ --url http://192.168.74.128:8879/charts/</span></span><br><span class="line">Regenerating index. This may take a moment.</span><br><span class="line">Now serving you on <span class="number">192.168</span>.<span class="number">74.128</span>:<span class="number">8879</span></span><br></pre></td></tr></table></figure>
<h4 id="四、在-Kubernetes-中构建"><a href="#四、在-Kubernetes-中构建" class="headerlink" title="四、在 Kubernetes 中构建"></a>四、在 Kubernetes 中构建</h4><h5 id="1、部署"><a href="#1、部署" class="headerlink" title="1、部署"></a>1、部署</h5><p>Chart 被发布到仓储后，就可以通过 <code>helm install</code> 命令部署该 Chart。</p>
<ul>
<li>检查配置和模板是否有效</li>
</ul>
<p>当使用 <code>helm install</code> 命令部署应用时，实际上就是将 templates 目录下的模板文件渲染成 Kubernetes 能够识别的 YAML 格式。</p>
<p>在部署前我们可以使用 <code>helm install --dry-run --debug &lt;chart_dir&gt; --name &lt;release_name&gt;</code>命令来验证 Chart 的配置。该输出中包含了模板的变量配置与最终渲染的 YAML 文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m local]#  helm install --dry-run --debug local/mychart --name kenneth-test</span><br><span class="line">[debug] Created tunnel using local port: &apos;40899&apos;</span><br><span class="line"></span><br><span class="line">[debug] SERVER: &quot;127.0.0.1:40899&quot;</span><br><span class="line"></span><br><span class="line">[debug] Original chart version: &quot;&quot;</span><br><span class="line">[debug] Fetched local/mychart to /root/.helm/cache/archive/mychart-0.1.0.tgz</span><br><span class="line"></span><br><span class="line">[debug] CHART PATH: /root/.helm/cache/archive/mychart-0.1.0.tgz</span><br><span class="line"></span><br><span class="line">NAME:   kenneth-test</span><br><span class="line">REVISION: 1</span><br><span class="line">RELEASED: Wed Apr 24 18:34:05 2019</span><br><span class="line">CHART: mychart-0.1.0</span><br><span class="line">USER-SUPPLIED VALUES:</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">COMPUTED VALUES:</span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line">image:</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  repository: nginx</span><br><span class="line">  tag: stable</span><br><span class="line">ingress:</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  enabled: false</span><br><span class="line">  hosts:</span><br><span class="line">  - host: chart-example.local</span><br><span class="line">    paths: []</span><br><span class="line">  tls: []</span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line">replicaCount: 1</span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">service:</span><br><span class="line">  port: 80</span><br><span class="line">  type: ClusterIP</span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">HOOKS:</span><br><span class="line">---</span><br><span class="line"># kenneth-test-mychart-test-connection</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: &quot;kenneth-test-mychart-test-connection&quot;</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: mychart</span><br><span class="line">    helm.sh/chart: mychart-0.1.0</span><br><span class="line">    app.kubernetes.io/instance: kenneth-test</span><br><span class="line">    app.kubernetes.io/managed-by: Tiller</span><br><span class="line">  annotations:</span><br><span class="line">    &quot;helm.sh/hook&quot;: test-success</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: wget</span><br><span class="line">      image: busybox</span><br><span class="line">      command: [&apos;wget&apos;]</span><br><span class="line">      args:  [&apos;kenneth-test-mychart:80&apos;]</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">MANIFEST:</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kenneth-test-mychart</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: mychart</span><br><span class="line">    helm.sh/chart: mychart-0.1.0</span><br><span class="line">    app.kubernetes.io/instance: kenneth-test</span><br><span class="line">    app.kubernetes.io/managed-by: Tiller</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      name: http</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: mychart</span><br><span class="line">    app.kubernetes.io/instance: kenneth-test</span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kenneth-test-mychart</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: mychart</span><br><span class="line">    helm.sh/chart: mychart-0.1.0</span><br><span class="line">    app.kubernetes.io/instance: kenneth-test</span><br><span class="line">    app.kubernetes.io/managed-by: Tiller</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: mychart</span><br><span class="line">      app.kubernetes.io/instance: kenneth-test</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: mychart</span><br><span class="line">        app.kubernetes.io/instance: kenneth-test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mychart</span><br><span class="line">          image: &quot;nginx:stable&quot;</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              protocol: TCP</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: http</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: http</span><br><span class="line">          resources:</span><br><span class="line">            &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>验证完成没有问题后，我们就可以使用以下命令将其部署到 Kubernetes 上了。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署时需指定 Chart 名及 Release（部署的实例）名。</span></span><br><span class="line">[root@k8s-m local]<span class="comment"># helm install local/mychart --name kenneth-test</span></span><br><span class="line">NAME:   kenneth-test</span><br><span class="line">LAST DEPLOYED: Wed Apr <span class="number">24</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">06</span> <span class="number">2019</span></span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Deployment</span><br><span class="line">NAME                  READY  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">kenneth-test-mychart  <span class="number">0</span>/<span class="number">1</span>    <span class="number">1</span>           <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                   READY  STATUS   RESTARTS  AGE</span><br><span class="line">kenneth-test-mychart-<span class="number">787</span>bb8d797-np5sq  <span class="number">0</span>/<span class="number">1</span>    Pending  <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                  TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE</span><br><span class="line">kenneth-test-mychart  ClusterIP  <span class="number">10.98</span>.<span class="number">233.146</span>  &lt;none&gt;       <span class="number">80</span>/TCP   <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line"><span class="number">1</span>. Get the application URL by running these commands:</span><br><span class="line">  export POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=kenneth-test"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">  echo <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> <span class="number">8080</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：helm install 默认会用到 socat，需要在所有节点上安装 socat 软件包。 </p>
</blockquote>
<p>完成部署后，现在 Nginx 就已经部署到 Kubernetes 集群上。在本地主机上执行提示中的命令后，就可在本机访问到该 Nginx 实例。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=kenneth-test"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">$ echo <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">$ kubectl port-forward <span class="variable">$POD_NAME</span> <span class="number">8080</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>使用下面的命令列出的所有已部署的 Release 以及其对应的 Chart。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m local]<span class="comment">#  helm list</span></span><br><span class="line">NAME            REVISION    UPDATED                     STATUS      CHART           APP VERSION NAMESPACE</span><br><span class="line">kenneth-test    <span class="number">1</span>           Wed Apr <span class="number">24</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">06</span> <span class="number">2019</span>    DEPLOYED    mychart-<span class="number">0.1</span>.<span class="number">0</span>   <span class="number">1.0</span>         default</span><br></pre></td></tr></table></figure>
<p>你还可以使用 <code>helm status</code> 查询一个特定的 Release 的状态。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m local]<span class="comment"># helm status kenneth-test</span></span><br><span class="line">LAST DEPLOYED: Wed Apr <span class="number">24</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">06</span> <span class="number">2019</span></span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Deployment</span><br><span class="line">NAME                  READY  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">kenneth-test-mychart  <span class="number">1</span>/<span class="number">1</span>    <span class="number">1</span>           <span class="number">1</span>          <span class="number">16</span>h</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                   READY  STATUS   RESTARTS  AGE</span><br><span class="line">kenneth-test-mychart-<span class="number">787</span>bb8d797-np5sq  <span class="number">1</span>/<span class="number">1</span>    Running  <span class="number">0</span>         <span class="number">16</span>h</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                  TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE</span><br><span class="line">kenneth-test-mychart  ClusterIP  <span class="number">10.98</span>.<span class="number">233.146</span>  &lt;none&gt;       <span class="number">80</span>/TCP   <span class="number">16</span>h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line"><span class="number">1</span>. Get the application URL by running these commands:</span><br><span class="line">  export POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=kenneth-test"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">  echo <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> <span class="number">8080</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<h5 id="2、升级"><a href="#2、升级" class="headerlink" title="2、升级"></a>2、升级</h5><p>从上面 <code>helm list</code> 输出的结果中我们可以看到有一个 Revision（更改历史）字段，该字段用于表示某一个 Release 被更新的次数，我们可以用该特性对已部署的 Release 进行回滚。</p>
<ul>
<li>修改 Chart.yaml 文件</li>
</ul>
<p>将版本号从 0.1.0 修改为 0.2.0, 然后使用 <code>helm package</code> 命令打包并发布到本地仓库。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># cat mychart/Chart.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">appVersion: <span class="string">"1.0"</span></span><br><span class="line">description: A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">name: mychart</span><br><span class="line">version: <span class="number">0.2</span>.<span class="number">0</span></span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm package mychart</span></span><br><span class="line">Successfully packaged chart and saved it to: /root/mychart-<span class="number">0.2</span>.<span class="number">0</span>.tgz</span><br></pre></td></tr></table></figure>
<ul>
<li>查询本地仓库中的 Chart 信息</li>
</ul>
<p>我们可以看到在本地仓库中 mychart 有两个版本。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m local]<span class="comment"># helm search mychart -l</span></span><br><span class="line">NAME            CHART VERSION   APP VERSION DESCRIPTION                </span><br><span class="line">local/mychart   <span class="number">0.2</span>.<span class="number">0</span>           <span class="number">1.0</span>         A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">local/mychart   <span class="number">0.1</span>.<span class="number">0</span>           <span class="number">1.0</span>         A Helm chart <span class="keyword">for</span> Kubernetes</span><br></pre></td></tr></table></figure>
<p>现在用 <code>helm upgrade</code> 命令将已部署的 mike-test 升级到新版本。你可以通过 <code>--version</code> 参数指定需要升级的版本号，如果没有指定版本号，则缺省使用最新版本。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m local]<span class="comment"># helm upgrade kenneth-test local/mychart</span></span><br><span class="line">Release <span class="string">"kenneth-test"</span> has been upgraded. Happy Helming!</span><br><span class="line">LAST DEPLOYED: Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">18</span> <span class="number">2019</span></span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Deployment</span><br><span class="line">NAME                  READY  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">kenneth-test-mychart  <span class="number">1</span>/<span class="number">1</span>    <span class="number">1</span>           <span class="number">1</span>          <span class="number">17</span>m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                   READY  STATUS   RESTARTS  AGE</span><br><span class="line">kenneth-test-mychart-<span class="number">787</span>bb8d797-lmkql  <span class="number">1</span>/<span class="number">1</span>    Running  <span class="number">0</span>         <span class="number">17</span>m</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                  TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE</span><br><span class="line">kenneth-test-mychart  ClusterIP  <span class="number">10.96</span>.<span class="number">134.114</span>  &lt;none&gt;       <span class="number">80</span>/TCP   <span class="number">17</span>m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line"><span class="number">1</span>. Get the application URL by running these commands:</span><br><span class="line">  export POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=kenneth-test"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">  echo <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> <span class="number">8080</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>完成后，可以看到已部署的 mike-test 被升级到 0.2.0 版本。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm list</span></span><br><span class="line">NAME            REVISION    UPDATED                     STATUS      CHART           APP VERSION NAMESPACE</span><br><span class="line">kenneth-test    <span class="number">2</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">18</span> <span class="number">2019</span>    DEPLOYED    mychart-<span class="number">0.2</span>.<span class="number">0</span>   <span class="number">1.0</span>         default</span><br></pre></td></tr></table></figure>
<h5 id="3、回退"><a href="#3、回退" class="headerlink" title="3、回退"></a>3、回退</h5><p>如果更新后的程序由于某些原因运行有问题，需要回退到旧版本的应用。首先我们可以使用 <code>helm history</code> 命令查看一个 Release 的所有变更记录</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm history kenneth-test</span></span><br><span class="line">REVISION    UPDATED                     STATUS      CHART           DESCRIPTION     </span><br><span class="line"><span class="number">1</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">38</span> <span class="number">2019</span>    SUPERSEDED  mychart-<span class="number">0.1</span>.<span class="number">0</span>   Install complete</span><br><span class="line"><span class="number">2</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">18</span> <span class="number">2019</span>    DEPLOYED    mychart-<span class="number">0.2</span>.<span class="number">0</span>   Upgrade complete</span><br></pre></td></tr></table></figure>
<p>其次，我们可以使用下面的命令对指定的应用进行回退。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm rollback kenneth-test 1</span></span><br><span class="line">Rollback was a success! Happy Helming!</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：其中的参数 1 是 helm history 查看到 Release 的历史记录中 REVISION 对应的值。</p>
</blockquote>
<p>最后，我们使用 <code>helm list</code> 和 <code>helm history</code> 命令都可以看到 mychart 的版本已经回退到 0.1.0 版本。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm list</span></span><br><span class="line">NAME            REVISION    UPDATED                     STATUS      CHART           APP VERSION NAMESPACE</span><br><span class="line">kenneth-test    <span class="number">3</span>           Thu Apr <span class="number">25</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">30</span> <span class="number">2019</span>    DEPLOYED    mychart-<span class="number">0.1</span>.<span class="number">0</span>   <span class="number">1.0</span>         default  </span><br><span class="line">[root@k8s-m ~]<span class="comment"># helm history kenneth-test</span></span><br><span class="line">REVISION    UPDATED                     STATUS      CHART           DESCRIPTION     </span><br><span class="line"><span class="number">1</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">38</span> <span class="number">2019</span>    SUPERSEDED  mychart-<span class="number">0.1</span>.<span class="number">0</span>   Install complete</span><br><span class="line"><span class="number">2</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">18</span> <span class="number">2019</span>    SUPERSEDED  mychart-<span class="number">0.2</span>.<span class="number">0</span>   Upgrade complete</span><br><span class="line"><span class="number">3</span>           Thu Apr <span class="number">25</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">30</span> <span class="number">2019</span>    DEPLOYED    mychart-<span class="number">0.1</span>.<span class="number">0</span>   Rollback to <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h5 id="4、删除"><a href="#4、删除" class="headerlink" title="4、删除"></a>4、删除</h5><p>如果需要删除一个已部署的 Release，可以利用 <code>helm delete</code> 命令来完成删除。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm delete kenneth-test</span></span><br><span class="line">release <span class="string">"kenneth-test"</span> deleted</span><br></pre></td></tr></table></figure>
<p>确认应用是否删除，该应用已被标记为 DELETED 状态。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm ls -a kenneth-test</span></span><br><span class="line">NAME            REVISION    UPDATED                     STATUS  CHART           APP VERSION NAMESPACE</span><br><span class="line">kenneth-test    <span class="number">3</span>           Thu Apr <span class="number">25</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">30</span> <span class="number">2019</span>    DELETED mychart-<span class="number">0.1</span>.<span class="number">0</span>   <span class="number">1.0</span>         default</span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>--deleted</code> 参数来列出已经删除的 Release </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm ls --deleted</span></span><br><span class="line">NAME            REVISION    UPDATED                     STATUS  CHART           APP VERSION NAMESPACE</span><br><span class="line">kenneth-test    <span class="number">3</span>           Thu Apr <span class="number">25</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">30</span> <span class="number">2019</span>    DELETED mychart-<span class="number">0.1</span>.<span class="number">0</span>   <span class="number">1.0</span>         default</span><br></pre></td></tr></table></figure>
<p>从上面的结果也可以看出，默认情况下已经删除的 Release 只是将状态标识为 DELETED 了 ，但该 Release 的历史信息还是继续被保存的。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm hist kenneth-test</span></span><br><span class="line">REVISION    UPDATED                     STATUS      CHART           DESCRIPTION      </span><br><span class="line"><span class="number">1</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">38</span> <span class="number">2019</span>    SUPERSEDED  mychart-<span class="number">0.1</span>.<span class="number">0</span>   Install complete </span><br><span class="line"><span class="number">2</span>           Thu Apr <span class="number">25</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">18</span> <span class="number">2019</span>    SUPERSEDED  mychart-<span class="number">0.2</span>.<span class="number">0</span>   Upgrade complete </span><br><span class="line"><span class="number">3</span>           Thu Apr <span class="number">25</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">30</span> <span class="number">2019</span>    DELETED     mychart-<span class="number">0.1</span>.<span class="number">0</span>   Deletion complete</span><br></pre></td></tr></table></figure>
<p>如果要移除指定 Release 所有相关的 Kubernetes 资源和 Release 的历史记录，可以用如下命令： </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m ~]<span class="comment"># helm delete --purge kenneth-test</span></span><br><span class="line">release <span class="string">"kenneth-test"</span> deleted</span><br></pre></td></tr></table></figure>
<p>再次查看已删除的 Release，已经无法找到相关信息。 </p>

        
    </section>
</article>



<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "f117eb282f890eafac3d",
        clientSecret: "13caf80f1f529128478f1fcbea32505d83fbea71",
        repo: "comment-repo",
        owner: "kenneth1996",
        admin: ["kenneth1996"],
        id: "2019/05/09/云原生-二-Helm-kubernetes包管理工具",
        distractionFreeMode: true,
        title: "云原生(二)Helm-kubernetes包管理工具",
        body: "http://kenneth96.coding.me/2019/05/09/云原生-二-Helm-kubernetes包管理工具/",
        labels: ["k8s"]
    }).render('comments');
    </script>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>

    
        &ensp;
        <span id="cnzz_stat_icon_1234567890" class="vm"></span>
        <script src="//s13.cnzz.com/stat.php?id=1234567890&show=pic" type="text/javascript"></script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        <script type="text/javascript" src="/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});
        </script>
    

</body>
</html>
